---
title: "R Notebook"
output: html_notebook
---

```{r}
library(here)
library(janitor)
library(stringr)
library(readxl)
library(fastICA)
library(tidyverse)
```

Rutas
```{r}

raw_data <- here("data", "raw")
interim_data <- here("data", "interim")
processed_data <- here("data", "processed")

```

Cargando datos

```{r}

datos = readRDS(paste0(processed_data, "/datos_tasa.Rds"))
datos_eda = readRDS(paste0(processed_data, "/datos_tasa_EDA.Rds"))

head(datos)
```


# Reduccion

## PCA

### Calculo del modelo
```{r}

datos_pca <- datos %>% 
  select("1":"3600")

prin_comp <- prcomp(datos_pca, scale. = T)

```


```{r}
biplot(prin_comp)

```

### Variabilidad explicada

```{r}

#compute standard deviation of each principal component
std_dev <- prin_comp$sdev

#compute variance
pr_var <- std_dev^2

#proportion of variance explained
prop_varex <- pr_var/sum(pr_var)
#summary(prin_comp)

#scree plot
plot(prop_varex[1:10], xlab = "Principal Component",
             ylab = "Proportion of Variance Explained",
             type = "b")

#cumulative scree plot
plot(cumsum(prop_varex[1:10]), xlab = "Principal Component",
              ylab = "Cumulative Proportion of Variance Explained",
              type = "b")

```

Un componente explica mas del 90% de la variabilidad. Especificamente el 92.8%


```{r}
aporte_variables<-prin_comp$rotation
```




### Correlacion entre datos y componentes

```{r}

cor_pca = cor(datos_pca, prin_comp$x)

round(apply(cor_pca[,1:10], 2, mean),2)

#plot(cor_pca[,1])

tibble(dias = 1:3600,
      plazo = c(rep("Corto plazo", 1080),
                 rep("Mediano plazo", 1080),
                 rep("Largo plazo", 1440)
                 ),
       correlacion = cor_pca[,1]
       ) %>% 
  ggplot(aes(x = dias, y = correlacion, color = plazo))+
  geom_point()+
  scale_color_brewer(palette = "Dark2") +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=seq(0, 10, 1))+
  ylab("Correlación") +
  xlab("Plazo") +
  ggtitle("Correlaciones del componente con las variables")

```

El primer componente tiene una correlacion promedio de 0.96 con respecto a las
3600 variables.
Al graficar las correlaciones del componenete para cada variable se observa que
varia entre .88 y .99 y que las correlaciones mas altas se ubican en el mediano plazo. Es decir, el componente captura mejor la variabilidad de las tasas a mediano y largo plazo.

## Independent Component Analysis (ICA)


### Calculo del modelo

```{r}

ica = icafast(datos_pca, nc = 10, center = T)

```

### Variabilidad explicada
```{r}

plot(ica$vafs, main = "Pre-processed data")
#plot(ica$X %*% ica$K, main = "PCA components")
#plot(ica$S, main = "ICA components")


```

Un componente explica mas del 75% de la variabilidad. Especificamente el 75.2%

### Correlacion entre datos y componentes

```{r}

cor_ica = cor(datos_pca, ica$S)

apply(-cor_ica, 2, mean)

#plot(cor_ica[,1])

tibble(dias = 1:3600,
      plazo = c(rep("Corto plazo", 1080),
                 rep("Mediano plazo", 1080),
                 rep("Largo plazo", 1440)
                 ),
       correlacion = -cor_ica[,1]
       ) %>% 
  ggplot(aes(x = dias, y = correlacion, color = plazo))+
  geom_point()+
  scale_color_brewer(palette = "Dark2") +
  theme(legend.title = element_blank(),
        plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=seq(0, 10, 1))+
  ylab("Correlación") +
  xlab("Plazo") +
  ggtitle("Correlaciones del componente con las variables")

```

El primer componente tiene una correlacion promedio de 0.85 con respecto a las
3600 variables.
Al graficar las correlaciones del componenete para cada variable se observa que
varia entre .73 y .94 y que las correlaciones mas altas se ubican en el corto plazo. Es decir, el componente captura mejor la variabilidad de las tasas en los corto periodos que en el mediano y largo plazo.





