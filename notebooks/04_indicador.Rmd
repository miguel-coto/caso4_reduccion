---
title: "R Notebook"
output: html_notebook
---

```{r,message=FALSE,warning=FALSE}
library(here)
library(tidyverse)
library(lubridate)
```

Rutas

```{r}
raw_data <- here("data", "raw")
processed_data <- here("data", "processed")

```

Cargando datos

```{r}
componentes = readRDS(paste0(processed_data, "/componentes.Rds"))
datos = readRDS(paste0(processed_data, "/datos_tasa_EDA.Rds"))
datos_long = readRDS(paste0(processed_data, "/datos_tasa.Rds"))

```



### Indicador

```{r}

#suma ponderado
#usando la proporcion de variancia explicada por cada componente

componentes<-componentes %>% mutate(IR= 0.93*PC1 + 0.056*PC2 + 0.011*PC3)


#Estandarizar indicador final

componentes<-componentes %>% 
  mutate(IR_S=(IR-mean(IR))/sd(IR))

summary(componentes)

```



### Validación 


```{r}
par(mfrow=c(1,2))

componentes %>%
  ggplot(aes(x = fecha, y = IR_S)) +
  geom_line() +
  geom_line(y=0,col="red",linetype = "dashed") +
  geom_line(y=median(componentes$IR_S),col="blue",linetype = "dashed") +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5)) +
  ylab("ICR") +
  xlab("Fecha") +
  ggtitle("Indicador")

#promedio y mediana de cada semana para compararlo

datos_long$promedio<-apply(datos_long[,c(7:3606)],1,mean)
datos_long$mediana<-apply(datos_long[,c(7:3606)],1,median)

base_temp<-datos_long %>% select(semana_rango,fecha,promedio,mediana)


base_temp %>%
  pivot_longer( 
    cols = -c(semana_rango,fecha), # Toma todas menos id
    names_to = "Medida",
    values_to = "Valor"
  ) %>% 
  ggplot(aes(x = fecha, y = Valor,group=Medida,colour=Medida)) +
  geom_line() +
  theme(plot.title = element_text(hjust = 0.5)) +
  ylab("") +
  xlab("Fecha") +
  ggtitle("Promedio y mediana por semana")


```

La forma del indicador tiende a ser similar a la del promedio de los rendimientos en cada semana.

Niveles del ICR superiores a cero señalan aumentos en los rendimientos mayores al promedio histórico,

El indicador comenzó a mostrar un nivel mayor al promedio histórico a finales de 2017 en la semana del 19-07-17 al 25-07-17, el indicador alcanzó su máximo absoluto en la semana del 13-03-19 al 19-03-19, alrededor de 2.3 desviaciones sobre la media y mostró niveles superiores a la media hasta la semana del 23-10-19 al 29-10-19


A inicios del 2020 a partir de la semana del 18-03-20 al 24-03-20 se observa una marcada tendencia positiva a pesar de presentar niveles por debajo de la media.


**Validación de curvas en tendencias positivas**

- Pendiente positiva en 2017 

En el año del 2017 se tienen 2 casos, el primero donde la tendencia es marcada a finales del mes de mayo e inicios de junio, aquí se observa que en 2017-06-06 los rendimientos de mediano y largo plazo tienen tasas mayores y hay una pendiente más pronunciada. 
En el segundo caso de la semana del 2017-09-19 a la del 2017-10-31, las pendientes se vuelven más pronunciadas y las tasas aumentan conforme el indicador aumenta.

```{r}

datos %>%
  filter(fecha=="2017-06-06" | fecha=="2017-05-30"| fecha== "2017-09-19"| fecha=="2017-09-26"
         | fecha=="2017-10-03"| fecha=="2017-10-10"| fecha==  "2017-10-17" | fecha=="2017-10-24"| fecha=="2017-10-31" ) %>% 
  arrange(fecha) %>% 
  mutate(fecha=as.factor(as.character(fecha))) %>% 
  mutate(Caso=c(rep(1,3600*2),rep(2,3600*7))) %>% 
  ggplot(aes(x = plazo_en_anos, y = tasa_percent, color = fecha)) +
  geom_line() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=seq(0, 10, 1))+
  ylim(0,15)+
  ylab("Tasas") +
  xlab("Plazo") +
  ggtitle("Curvas de rendimientos ")+
  facet_grid(~Caso)

```

- Pendiente positiva en 2018

En este caso en el corto y en el largo plazo las tasas aumentan al aumentar el indicador

```{r}

datos %>%
  filter(fecha=="2018-12-25" | fecha=="2018-12-18" ) %>% 
  arrange(fecha) %>% 
  mutate(fecha=as.factor(fecha)) %>% 
  ggplot(aes(x = plazo_en_anos, y = tasa_percent, colour = fecha)) +
  geom_line() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=seq(0, 10, 1))+
  ylim(0,15)+
  ylab("Tasas") +
  xlab("Plazo") +
  ggtitle("Curvas de rendimientos ")

```

- Pendiente positiva en 2019

En este caso en el mediano y en el largo plazo las tasas aumentan al aumentar el indicador

```{r}

datos %>%
  filter(fecha=="2019-03-12" | fecha=="2019-03-19" ) %>% 
  arrange(fecha) %>% 
  mutate(fecha=as.factor(fecha)) %>% 
  ggplot(aes(x = plazo_en_anos, y = tasa_percent, colour = fecha)) +
  geom_line() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=seq(0, 10, 1))+
  ylim(0,15)+
  ylab("Tasas") +
  xlab("Plazo") +
  ggtitle("Curvas de rendimientos ")

```

- Pendiente positiva en 2020


Curvas con pendientes más pronunciadas y mayores tasas al aumentar el indicador

```{r}

datos %>%
  filter(fecha=="2020-03-24" | fecha=="2020-03-31"|fecha=="2020-04-07" | fecha=="2020-04-21"  ) %>% 
  arrange(fecha) %>% 
  mutate(fecha=as.factor(fecha)) %>% 
  ggplot(aes(x = plazo_en_anos, y = tasa_percent, colour = fecha)) +
  geom_line() +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=seq(0, 10, 1))+
  ylim(0,15)+
  ylab("Tasas") +
  xlab("Plazo") +
  ggtitle("Curvas de rendimientos ")

```



### Calibración










